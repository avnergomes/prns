<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mapa – v1.0 (c) Avner Gomes</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html,body,#map{height:100%;margin:0}
    .topbar{position:fixed;inset:0 0 auto 0;z-index:1000;display:flex;gap:.5rem;align-items:center;background:#fff;border-bottom:1px solid #e5e7eb;padding:.5rem .75rem}
    .version{margin-left:auto;color:#666;font-size:.85rem;white-space:nowrap}
    #map{position:absolute;inset:44px 0 0 0}
    .btn{border:1px solid #d1d5db;background:#fff;padding:.35rem .6rem;border-radius:8px;font-weight:600;cursor:pointer}
    .btn:hover{background:#f9fafb}
  </style>
</head>
<body>
  <div class="topbar">
    <button id="fitAll" class="btn">Ajustar visão</button>
    <div class="version">v1.0 (c) Avner Gomes</div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  // --- mapa base ---
  const map = L.map('map', { center: [-24.5,-51.5], zoom: 7, preferCanvas: true });

  const streets = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap • © CARTO', maxZoom: 20
  }).addTo(map);

  const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Imagery: Esri/Maxar', maxZoom: 19
  });

  const baseLayers = { 'Streets': streets, 'Satélite (Esri)': esri };
  const layerControl = L.control.layers(baseLayers, {}, { collapsed:false }).addTo(map);

  // --- estilos rápidos ---
  const styles = {
    declividade: { color:'#c51b7d', weight:2, fillOpacity:0.20 },
    altimetria:  { color:'#542788', weight:2, fillOpacity:0.20 },
    uso_solo:    { color:'#1b7837', weight:2, fillOpacity:0.15 },
    estradas:    { color:'#ff9900', weight:3, fillOpacity:0 },
    hidrografia: { color:'#2b8cbe', weight:2, fillOpacity:0.15 },
    nascentes:   { color:'#2166ac', weight:2, fillOpacity:0.8 },
    solos:       { color:'#8c510a', weight:2, fillOpacity:0.15 },
    construcoes: { color:'#7f0000', weight:2, fillOpacity:0.6 },
    caf:         { color:'#006d2c', weight:2, fillOpacity:0.25 },
    educacao:    { color:'#253494', weight:2, fillOpacity:0.6 },
    sigarh:      { color:'#0571b0', weight:2, fillOpacity:0.25 }
  };

  // --- lista de camadas (em /data) ---
  const LAYERS = [
    { name:'Declividade (OTTO)', file:'declividade__declividade_otto.geojson', key:'declividade', type:'poly' },
    { name:'Altimetria (OTTO)',  file:'altimetria.geojson',  key:'altimetria',  type:'poly' },
    { name:'Uso do Solo (OTTO)', file:'uso_solo__usodosolo_otto.geojson',     key:'uso_solo',    type:'poly' },
    { name:'Estradas (OTTO)',    file:'estradas__estradas_otto.geojson',      key:'estradas',    type:'line' },
    { name:'Hidrografia (OTTO)', file:'hidrografia__hidrografia_otto.geojson',key:'hidrografia', type:'line' },
    { name:'Nascentes (OTTO)',   file:'nascentes__nascentes_otto.geojson',    key:'nascentes',   type:'point' },
    { name:'Solos (OTTO)',       file:'solos__solos_otto.geojson',            key:'solos',       type:'poly' },
    { name:'Construções (OTTO)', file:'construcoes__construcoes_otto.geojson',key:'construcoes', type:'point' },
    { name:'CAF',                file:'caf.geojson',                           key:'caf',         type:'poly' },
    { name:'Educação (OTTO)',    file:'educacao__educacao_otto.geojson',      key:'educacao',    type:'point' },
    { name:'SIGARH',             file:'sigarh.geojson',                        key:'sigarh',      type:'poly' }
  ];

  const addedLayers = [];

  function addGeoJson(def, data){
    const st = styles[def.key] || { color:'#555', weight:2, fillOpacity:0.2 };
    const layer = L.geoJSON(data, {
      style: st,
      pointToLayer: (f, latlng) => {
        if(def.type==='point'){
          return L.circleMarker(latlng, { radius:5, color:st.color, weight:2, fillOpacity:st.fillOpacity ?? 0.8 });
        }
        return L.marker(latlng); // (não será chamado para polígonos/linhas)
      },
      onEachFeature: (feat, lyr) => {
        const p = feat && feat.properties || {};
        const html = Object.keys(p).slice(0,12)
          .map(k => `<div><b>${k}</b>: ${String(p[k])}</div>`).join('');
        if(html) lyr.bindPopup(html);
      }
    });

    layer.addTo(map);
    addedLayers.push(layer);
    layerControl.addOverlay(layer, def.name);
  }

  async function loadAll(){
    for(const def of LAYERS){
      const url = `data/${def.file}`;
      try{
        const res = await fetch(url, { cache:'no-cache' });
        if(!res.ok){
          const txt = await res.text().catch(()=> '');
          throw new Error(`HTTP ${res.status} ${res.statusText} ao buscar ${url}\n${txt.slice(0,180)}`);
        }
        let gj;
        try{
          gj = await res.json();
        }catch(parseErr){
          const txt = await res.text().catch(()=> '');
          throw new Error(`Falha ao interpretar JSON em ${def.name}. Detalhe: ${parseErr.message}\nPrévia: ${txt.slice(0,180)}`);
        }
        addGeoJson(def, gj);
      }catch(e){
        console.error(`Falha ao carregar ${def.name}:`, e);
        alert(`Falha ao carregar ${def.name} (${url}). Veja o console para detalhes.`);
      }
    }
  }

  loadAll().then(()=>console.log('Camadas carregadas.'));

  document.getElementById('fitAll').onclick = () => {
    const visibles = addedLayers.filter(l => map.hasLayer(l));
    if(!visibles.length) return;
    const group = L.featureGroup(visibles);
    map.fitBounds(group.getBounds().pad(0.08));
  };

  // assinatura no rodapé do mapa
  map.attributionControl.setPrefix(false);
  map.attributionControl.addAttribution('v1.0 (c) Avner Gomes');
  </script>
</body>
</html>
